name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]

env:
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # LINT & FORMAT CHECK
  # ============================================================================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: Check TypeScript types
        run: npm run type-check

      - name: Check code formatting
        run: npm run format:check

  # ============================================================================
  # UNIT & INTEGRATION TESTS
  # ============================================================================
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit -- --coverage

      - name: Run integration tests
        run: npm run test:integration

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-${{ matrix.node-version }}

  # ============================================================================
  # SELECTOR CONFIG VALIDATION
  # ============================================================================
  validate-configs:
    name: Validate Selector Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate all platform configs
        run: npm run validate:configs

      - name: Check for breaking config changes
        run: npm run test:config-compatibility

  # ============================================================================
  # BUILD EXTENSION
  # ============================================================================
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: [lint, test, validate-configs]
    strategy:
      matrix:
        browser: [chrome, firefox]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for ${{ matrix.browser }}
        run: npm run build:${{ matrix.browser }}

      - name: Verify build output
        run: |
          test -f dist/manifest.json || exit 1
          test -d dist/assets || exit 1
          echo "Build verification passed"

      - name: Calculate bundle size
        run: |
          du -sh dist
          du -sh dist/assets

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: extension-${{ matrix.browser }}-${{ github.sha }}
          path: dist/
          retention-days: 30

  # ============================================================================
  # SECURITY AUDIT
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Check for known CVEs in dependencies
        run: npm run security:check

  # ============================================================================
  # PERFORMANCE BENCHMARKS
  # ============================================================================
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run detection benchmarks
        run: npm run benchmark

      - name: Compare with baseline
        run: npm run benchmark:compare

      - name: Post benchmark results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('./benchmark-results.json', 'utf8'));
            
            let comment = '## ðŸ“Š Performance Benchmark Results\n\n';
            comment += '| Platform | Detection Time | Memory Usage | Change |\n';
            comment += '|----------|---------------|--------------|--------|\n';
            
            for (const [platform, data] of Object.entries(results)) {
              comment += `| ${platform} | ${data.time}ms | ${data.memory}MB | ${data.change} |\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================================================
  # PACKAGE & RELEASE
  # ============================================================================
  package:
    name: Package Extension
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'release'
    strategy:
      matrix:
        browser: [chrome, firefox]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: extension-${{ matrix.browser }}-${{ github.sha }}
          path: dist/

      - name: Create ZIP package
        run: |
          cd dist
          zip -r ../ad-mirror-${{ matrix.browser }}-${{ github.ref_name }}.zip .
          cd ..

      - name: Generate SHA256 checksums
        run: |
          sha256sum ad-mirror-${{ matrix.browser }}-${{ github.ref_name }}.zip > checksums.txt

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./ad-mirror-${{ matrix.browser }}-${{ github.ref_name }}.zip
          asset_name: ad-mirror-${{ matrix.browser }}-${{ github.ref_name }}.zip
          asset_content_type: application/zip

  # ============================================================================
  # AUTO-PUBLISH TO CHROME WEB STORE (Optional)
  # ============================================================================
  publish-chrome:
    name: Publish to Chrome Web Store
    runs-on: ubuntu-latest
    needs: [package]
    if: github.event_name == 'release' && !github.event.release.prerelease
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Chrome build
        uses: actions/download-artifact@v3
        with:
          name: extension-chrome-${{ github.sha }}
          path: dist/

      - name: Publish to Chrome Web Store
        uses: mnao305/chrome-extension-upload@v4
        with:
          file-path: dist/
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}

  # ============================================================================
  # DEPLOY DOCUMENTATION
  # ============================================================================
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build documentation
        run: npm run docs:build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs-build
          cname: ad-mirror.example.com

  # ============================================================================
  # METRICS & REPORTING
  # ============================================================================
  metrics:
    name: Collect Metrics
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze code metrics
        run: |
          npm run metrics:generate

      - name: Update metrics dashboard
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const metrics = JSON.parse(fs.readFileSync('./metrics.json', 'utf8'));
            
            console.log('Code Metrics:');
            console.log(`- Total Lines: ${metrics.totalLines}`);
            console.log(`- Test Coverage: ${metrics.coverage}%`);
            console.log(`- Selector Rules: ${metrics.selectorRules}`);
            console.log(`- Detection Accuracy: ${metrics.accuracy}%`);

